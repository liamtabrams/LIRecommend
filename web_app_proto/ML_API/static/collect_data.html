<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collect Data</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        /* CSS styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-container {
            display: flex;
            width: 87%;
            max-width: 1400px;
            border-radius: 5px; /* Removed border */
            overflow: hidden;
            margin-top: 10px; /* Adjusted margin-top to 10px */
            height: auto; /* Set height to auto */
        }
        .left-container, .right-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .left-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center; /* Center-align text */
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
            text-align: center; /* Center-align text */
        }
        /* Center the default text in the select dropdown */
        select option {
            text-align: center;
        }
        button {
            padding: 10px 20px;
            background-color: #000; /* Changed background color to black */
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 20px; /* Adjusted margin-top to 20px */
        }
        button:hover {
            background-color: #333; /* Darken the hover color */
        }
        #output {
            margin-top: 20px;
        }
        h3 {
            margin-top: 30px;
            font-weight: bold
            text-align: center;
        }
        h4 {
            margin-top: 30px;
            font-weight: bold;
        }
        p {
            margin-top: 10px;
            line-height: 1.6;
        }
        .scrollable {
            overflow-x: auto;
        }
        .table-container {
            max-height: 400px;
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .collapsible-content {
            display: block;
            overflow: hidden;
        }
        table.dataTable thead th {
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
            z-index: 100;
        }
        .home-link, .predict-link {
            position: fixed;
            left: 10px;
            font-size: 14px;
        }
        .home-link {
            top: 10px;
        }
        .predict-link {
            top: 40px; /* Positioning the Predict link under Home link */
        }
        .dataset-section {
            width: 90%;
            max-width: 1400px;
            margin-top: 20px; /* Adjusted margin-top to 20px */
        }
        .metrics-container {
            width: 85%;
            max-width: 1400px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px; /* Removed border */
        }
        .metrics-container div {
            flex: 1 1 calc(33% - 10px);
            margin: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }
        .toggle-button-container button {
            padding: 15px 30px; /* Increase padding */
            font-weight: bold; /* Bold font */
            font-size: 16px; /* Larger font size */
            background-color: #333; /* Dark background color */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .toggle-button-container button:hover {
            background-color: #555; /* Darken the hover color */
        }
        .download-options-container {
            text-align: center;
            margin-top: 0px;
        }
        a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        a:hover {
            color: #0056b3;
        }
        #loadingMessage {
            display: none; /* Initially hidden */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 20px;
            border-radius: 10px;
            z-index: 1000; /* Ensure it is above other elements */
        }
        /* Other CSS styles */
        .download-all-button {
            margin-top: 20px;
        }
        .download-all-button button {
            background-color: #000;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .download-all-button button:hover {
            background-color: #333;
        }
    </style>
</head>
<body>
    <a href="/static/landing_page.html" class="home-link">Home</a>
    <a href="/static/index.html" class="predict-link">Recommend</a>
    <div class="main-container">
        <div class="left-container">
            <h2>Append to Dataset</h2>
            <label for="url">Enter job posting URL:</label>
            <input type="text" id="url" name="url" placeholder="https://www.linkedin.com/jobs/view/the-rest" required>
            <label for="rating">Select rating:</label>
            <select id="rating" name="rating" required>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            <button onclick="collectData()">Submit</button>
            <button onclick="retrainModelEvaluate()">Retrain Model/Get Model Info</button>
            <div id="output"></div>
        </div>
        <div class="right-container">
            <h3>Model Performance Metrics</h3>
            <h4>What are good values for accuracy and error?</h4>
            <p>
                There is inherent subjectivity in the application of the rating system and everyone will have their own
                 unique corner cases which make modeling difficult. However, based on experiments of a user's drift over
                 a 2-month period, the upper bound for accuracy is around 65% while the lower bounds for mean squared and 
                 absolute error are around .35. Thus, a model achieving at least 60% accuracy and MAEs (Mean Absolute Error) 
                 and MSEs (Mean Squared Error) of less than .5 is doing quite well. We want to maximize the accuracy score 
                 while minimizing the error scores. For the case of the Random Forest Classifier model, the MSE will always
                 be greater than the MAE unless there are no predictions that are more than 1 rating point off, which is
                 another indication the model is doing quite well. So we want the MAE and MSE values to not differ too much. 
            </p>
        </div>
    </div>

    <div class="metrics-container">
        <div id="accuracy_avg">Accuracy Average: --</div>
        <div id="accuracy_std">Accuracy Std Dev: --</div>
        <div id="mae_avg">MAE Average: --</div>
        <div id="mae_std">MAE Std Dev: --</div>
        <div id="mse_avg">MSE Average: --</div>
        <div id="mse_std">MSE Std Dev: --</div>
    </div>

    <div class="download-options-container">
        <button onclick="downloadFile('dataset')">Download Dataset (CSV)</button>
        <button onclick="downloadFile('tfidf-model')">Download TFIDF Model</button>
        <button onclick="downloadFile('rf-model')">Download Random Forest Model</button>
    </div>

    <div class="download-all-button">
        <button onclick="downloadAll()">Download All</button> <!-- New button for Download All -->
    </div>

    <div class="toggle-button-container">
        <button onclick="toggleCollapsible()">
            <span style="margin-right: 5px;">&#9650;</span> <!-- Up arrow symbol -->
            Hide/Show Dataset 
            <span style="margin-left: 5px;">&#9660;</span> <!-- Down arrow symbol -->
        </button>
    </div>

    <div class="dataset-section">
        <div id="collapsible-content" class="collapsible-content">
            <div class="table-container">
                <div class="scrollable">
                    <table id="dataset-table" class="display">
                        <thead>
                            <tr>
                                <th>Posting Text</th>
                                <th>Min Salary</th>
                                <th>Max Salary</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingMessage">Please wait while the model is being retrained and thoroughly evaluated...</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        function retrainModelEvaluate() {
            showLoadingMessage();
            fetch('/retrain-model-evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('accuracy_avg').innerText = `Accuracy Average: ${data.accuracy_avg}%`;
                document.getElementById('accuracy_std').innerText = `Accuracy Std Dev: ${data.accuracy_std}%`;
                document.getElementById('mae_avg').innerText = `MAE Average: ${data.mae_avg}`;
                document.getElementById('mae_std').innerText = `MAE Std Dev: ${data.mae_std}`;
                document.getElementById('mse_avg').innerText = `MSE Average: ${data.mse_avg}`;
                document.getElementById('mse_std').innerText = `MSE Std Dev: ${data.mse_std}`;
                hideLoadingMessage();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred. Please try again.");
                hideLoadingMessage();
            });
        }

        function collectData() {
            var urlInput = document.getElementById("url").value;
            var ratingInput = document.getElementById("rating").value;
            if (!isValidURL(urlInput)) {
                alert("Please enter a valid URL.");
                return;
            }
            var data = {
                "url": urlInput,
                "rating": ratingInput
            };
            fetch('/submit-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.getElementById("output").innerText = "Data submitted successfully.";
                document.getElementById("url").value = "";
                document.getElementById("rating").value = "0";
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("output").innerText = "Error occurred. Please try again.";
            });
        }

        function isValidURL(url) {
            const regex = /^(https?|chrome):\/\/[^\s$.?#].[^\s]*$/gm;
            return regex.test(url);
        }

        function fetchDataset() {
            var table = $('#dataset-table').DataTable();
            table.clear().draw();
            fetch(`/dataset`)
            .then(response => response.json())
            .then(data => {
                data.forEach(row => {
                    table.row.add([
                        row.posting_text,
                        row.min_salary,
                        row.max_salary,
                        row.rating
                    ]).draw();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while fetching the dataset.");
            });
        }

        function toggleCollapsible() {
            var content = document.getElementById("collapsible-content");
            if (content.style.display === "none" || content.style.display === "") {
                content.style.display = "block";
            } else {
                content.style.display = "none";
            }
        }

        function showLoadingMessage() {
            document.getElementById('loadingMessage').style.display = 'block';
        }

        function hideLoadingMessage() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        $(document).ready(function() {
            $('#dataset-table').DataTable({
                "paging": true,
                "scrollY": "300px",
                "scrollCollapse": true,
                "autoWidth": true,
                "pageLength": 10,
                "lengthChange": false,
                "language": {
                    "emptyTable": "Dataset loading..."
                }
            });
            document.getElementById("collapsible-content").style.display = "block";
            fetchDataset();
        });
        
        function downloadFile(type) {
            let url = '';
            switch (type) {
                case 'dataset':
                    url = '/download-dataset';
                    break;
                case 'tfidf-model':
                    url = '/download-tfidf-model';
                    break;
                case 'rf-model':
                    url = '/download-rf-model';
                    break;
            }
            window.location.href = url;
        }
        // Function to trigger the download of all files
        function downloadAll() {
            // Send a GET request to the /download-all endpoint
            fetch('/download-all')
                .then(response => {
                    // Check if the response status is OK
                    if (!response.ok) {
                        // If not, throw an error
                        throw new Error('Failed to download all files');
                    }
                    // Return the response body as a blob
                    return response.blob();
                })
                .then(blob => {
                    // Create a URL for the blob
                    const url = window.URL.createObjectURL(blob);
                    // Create an anchor element to trigger the download
                    const a = document.createElement('a');
                    // Set the href attribute of the anchor to the blob URL
                    a.href = url;
                    // Set the download attribute to specify the filename
                    a.download = 'user_data.zip';
                    // Append the anchor to the document body
                    document.body.appendChild(a);
                    // Click the anchor to trigger the download
                    a.click();
                    // Remove the anchor from the document body
                    document.body.removeChild(a);
                    // Revoke the blob URL to free up memory
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    // Log any errors to the console
                    console.error('Error:', error);
                    // Display an error message to the user
                    alert('Failed to download all files');
                });
        }
    </script>
</body>
</html>

